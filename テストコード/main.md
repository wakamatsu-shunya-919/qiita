<!-- 
title: 長く愛されてるプロダクトのテストコード再構築 —— ジュニアエンジニアが考える『腐らせない』ためのテストコード設計」
tags: テスト
-->

### はじめに

はじめましての方ははじめまして、そうでない方はこんにちは。ジュニアエンジニアの若松です。社内ではじぇっとって呼ばれています。なぜ呼ばれているかは追々。

さて今回は表題に書かれているように、私が最近考察していることを書いていこうかなと思います。

長期間愛されてきているプロダクトには、共通して避けがたい性質があると思います。それは 時間の経過とともに技術負債が蓄積しやすい ということです。

これは（いくつかの理由を書く）で仕方ないことなのかなと思います。

しかしその中でも特に目につきやすいのが、テストコードの形骸化 です。

- テストは存在するが、失敗しても誰も直さない
- 仕様変更のたびに壊れ、結局コメントアウトされる
- 「このテスト、何を保証したいんだっけ？」と誰も答えられない

結果として、テストがあるはずなのに安心して変更できなかったり、リファクタリングするにもテストコードを活用せず行いデグレが起きてしまったりして、開発スピードが落ちていきます。（人間は正解に縋りたい生物であるはずなんですけどね。）

そこで本記事では、ジュニアエンジニアの視点 から

「将来にわたって価値を生み続けるテストコードとは何か？」

を整理・考察してみます。

### 「メンテナンスされないテスト」の共通点

まず、長く運用される中で 放置されがちなテストコード には、運用工数が確保できないというのはおいておいて、テストコード自体に注目すると、いくつかの共通点があると感じました。

- 可読性の欠如： 複雑なロジックがテストコード側に混入している。
- 環境依存： 特定の条件下でしか通らないテスト。
- 意図の不明瞭さ： 何をテストしたいのか、期待値の根拠が不明。

**可読性の欠如**

テストコード内に、

- 条件分岐
- ループ
- 複雑な前処理ロジック

が入り込み、テストなのか実装なのか分からない状態 になっているケースです。

テストを読んでも「どういう振る舞いを確認しているのか」が直感的に分からず、

結果として誰も触らなくなります。

**環境依存**

- 実行順に依存している
- 特定のDB状態や時間に依存している
- ローカルでは通るがCIでは落ちる

このようなテストは、壊れやすく、信用されなくなります。

「たまに落ちるテスト」は、最終的に「無視されるテスト」になります。

**意図の不明瞭さ**

- 期待値がなぜその値なのか分からない
- テスト名から仕様が読み取れない
- 変更時に「消していいのか判断できない」

これは、テストが仕様を語れていない状態 だと言えます。

### 考察：長期運用に耐えうるテスト設計とは

では、「腐らないテストコード」とはどんなものなのでしょうか。

- 「仕様書」としてのテスト

    ユニットテストを、メソッドの振る舞いを説明する最小単位のドキュメントとして捉えられるべきだと思っています。

    理想は、
    - テスト名を読むだけで仕様が分かる
    - テストコードを読むと、実装の意図が理解できる

    状態だと思います。
    実装が変わっても、仕様が変わらない限りテストは変えないという関係性が保てると、テストは価値を持ち続けます。
- DRYよりもDAMP（Descriptive And Meaningful Phrases）： テストコードでは過度な共通化を避け、あえて冗長に書いても分かりやすさを優先する考え方。
    - テストは説明しすぎくらいがちょうどいい
    - 
- 言語やツールに依存しない本質： どの言語でも共通して使える「AAA（Arrange-Act-Assert）パターン」などの型。
    - 事前状態を正しく把握できない状態でのテストコードを書くと、読みづらい不安定なテストコードをかくことになってしまう。
    - テストに関係している値は、テストコード外に書くとつらい。なるべく近くに配置する
- テストが書きやすいコードを書く
    - 上のような方法でテストコードを書く中で、実際のコードの方も、テストしやすいコードっていうのを考えて行く必要がある
        - 関心の分離
        - 依存性の注入
        - 副作用の少ないコードを書く

    - プロダクションコードを書き換えたときに、修正に失敗していることに気づくまでの時間が短い
    - なぜその修正だとだめなのかを理解できるまでの時間が短い

### チームで「品質」を育てるアプローチ

- **文化とマインドセットの醸成**
    - **目的の共有**: 単に「テストを書く」こと自体が目的ではなく、**「ソフトウェアの品質を確保し、中長期的な生産性を向上させる」**という共通の目的意識を持つことが重要です。
    - **「テストを書いてよかった」体験の創出**: 開発者がテストコードの恩恵（バグの早期発見、安心してリファクタリングできるなど）を実感できるような機会を作ります。
    - **学習と知識共有**: 定期的な勉強会やペアプログラミングを通じて、テストの書き方や成功事例を共有し、チーム全体のスキルアップを図ります。
    - **心理的安全性の確保**: テストコードに関する失敗を責めず、改善のためのフィードバックが活発に行われる環境を構築します
- **ソフトウェアが対処するべきビジネスの問題にどれだけ関心を示しているのか**
    - 仕様書としてのテストコードを書くには、エンジニアが企画提案者と密接になって仕事しているかが求められる
    - めんどくさいUIを操作していたテストをコードに落とせる。ビジネスロジックとして知ったことをそのままテストに落とせる
    - そうした仕様書となるテストコードに、ビジネス側の事情を落としていけるチーム構成にする必要がある
- **仕組みとしての継続的な運用**
    - Ciによる自動化は不可欠。人間は退屈には耐えられない
    - 管理対象の増加：コード、ドキュメント等と加え、テストコードも更新していく対象となるので、管理が大変になるし、それらが一致している重要性がある

### おわりに

現実的には、すべてテストして、そのテストを100点にするのは難しいし、納期・人員・優先度などのビジネス的制約もあると思います。

なので、今後も継続して変更が起こり得たり、さまざまな観点でデグレやバグが許されない箇所から優先して、メリハリを大切にする必要があります。

技術負債に向き合いテストコードを書いていくことは単なる「掃除」ではなく プロダクト理解を深める行為 だと思っています。

対象となるコードの意図や仕様を理解していなければ、テストコードは記述できません。自身が記述したコードはもちろん、他者が記述したコードを読むことで、仕様理解が深まります。

アサインしたばかりのジュニアエンジニアだからこそ気づける無知や違和感を大切にしながら、

未来の自分やチームを助けるテストコード を残していきたいです。